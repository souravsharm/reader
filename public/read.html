<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading - Text Reader</title>
    <link rel="stylesheet" href="styles.css?v=20260208-3">
</head>
<body>
    <article class="reading-container">
        <header class="reading-header">
            <a href="/" class="back-btn">&larr; Paste New Text</a>
            <h1>Your Text</h1>
        </header>

        <main class="reading-content">
            <div id="textContent">
                <p class="loading">Loading your text...</p>
            </div>
        </main>

        <footer class="reading-footer">
            <a href="/" class="btn-secondary">&larr; Back to Paste</a>
        </footer>
    </article>

    <script>
        /**
         * Simple rule:
         * - User ends each paragraph with "$$".
         * - "$$" is converted to paragraph breaks.
         */
        function reconstructParagraphs(text) {
            if (!text || !text.trim()) {
                return '<p class="no-text">No text available. <a href="/">Go back</a> and paste some text.</p>';
            }

            const normalized = normalizeInputText(text);
            const rawParagraphs = normalized.split(/\n[ \t]*\n+/);
            const out = [];

            for (const raw of rawParagraphs) {
                const paragraph = raw
                    .split('\n')
                    .map((line) => line.trim())
                    .filter(Boolean)
                    .join(' ')
                    .replace(/\s+/g, ' ')
                    .trim();

                if (!paragraph) continue;
                out.push(`<p class="prose">${escapeHtml(paragraph)}</p>`);
            }

            return out.length > 0
                ? out.join('\n')
                : '<p class="no-text">No text available. <a href="/">Go back</a> and paste some text.</p>';
        }

        function normalizeInputText(text) {
            return text
                .replace(/\r\n/g, '\n')
                .replace(/\r/g, '\n')
                .replace(/[\u2028\u2029]/g, '\n')
                .replace(/[\u00A0\u2007\u202F]/g, ' ')
                .replace(/[ \t]*\$\$[ \t]*/g, '\n\n')
                .replace(/\n{3,}/g, '\n\n')
                .trim();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadText() {
            try {
                const response = await fetch('/get-text');
                const data = await response.json();
                const textContent = document.getElementById('textContent');

                if (data.text && data.text.trim()) {
                    textContent.innerHTML = reconstructParagraphs(data.text);
                } else {
                    textContent.innerHTML = '<p class="no-text">No text available. <a href="/">Go back</a> and paste some text.</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('textContent').innerHTML =
                    '<p class="error">Failed to load text. <a href="/">Try again</a></p>';
            }
        }

        loadText();
    </script>
</body>
</html>
